# Scala 3 runtime with the0 daemon binary
# Used for Scala bot execution in both Docker and K8s modes
# Runs pre-compiled JAR files

# Stage 1: Build the runtime binary
FROM golang:1.24-alpine AS runtime-builder
RUN apk --no-cache add make git
WORKDIR /build
COPY runtime/go.mod runtime/go.sum ./
RUN go mod download
COPY runtime/ .
RUN CGO_ENABLED=0 go build -ldflags="-s -w" -o runtime ./cmd/app

# Stage 2: Final image (JRE only, no need for full JDK)
FROM eclipse-temurin:21-jre

# Install bash (required for entrypoint scripts)
RUN apt-get update && apt-get install -y --no-install-recommends \
    bash \
    && rm -rf /var/lib/apt/lists/*

# Copy runtime binary
COPY --from=runtime-builder /build/runtime /app/runtime
RUN chmod 755 /app/runtime

# Create required directories
RUN mkdir -p /bot /state /var/the0/logs

# Default working directory
WORKDIR /bot

# Default command runs bash (entrypoint.sh will be generated by daemon init)
CMD ["/bin/bash", "/bot/entrypoint.sh"]
