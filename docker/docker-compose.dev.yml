services:
  # Development override for frontend with hot reloading
  the0-frontend:
    image: node:20-alpine
    user: "1000:1000"
    working_dir: /app
    volumes:
      - ../frontend:/app
      - frontend_node_modules:/app/node_modules
    environment:
      NODE_ENV: development
      WATCHPACK_POLLING: true
      CHOKIDAR_USEPOLLING: true
      NEXT_PUBLIC_API_URL: http://localhost:3000
      BOT_API_URL: http://the0-api:3000
      CLI_DOWNLOAD_BASE_URL: https://github.com/your-org/the0-oss/releases/download
      CLI_INSTALL_BASE_URL: http://localhost:3001
      NEXT_PUBLIC_CLI_INSTALL_BASE_URL: http://localhost:3001
      JWT_SECRET: your-super-secret-jwt-key-change-this-in-production
      NEXT_PUBLIC_APP_NAME: "the0"
      NEXT_PUBLIC_APP_VERSION: "1.0.0"
      NEXT_BASE_URL: http://localhost:3001
    ports:
      - "3001:3000"
    command: sh -c "rm -rf .next && yarn install && yarn dev"
    depends_on:
      - the0-api
    networks:
      - the0-network

  # Development override for API with hot reloading
  the0-api:
    image: node:20-alpine
    user: "1000:1000"
    working_dir: /app
    volumes:
      - ../api:/app
      - api_node_modules:/app/node_modules
    extra_hosts:
      - "localhost:host-gateway"
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://the0:the0_password@postgres:5432/the0_oss?sslmode=disable
      DATABASE_TYPE: postgres
      NATS_URL: nats://nats:4222
      NATS_SUBJECT_PREFIX: the0
      MINIO_ENDPOINT: localhost
      MINIO_PORT: "9000"
      MINIO_ACCESS_KEY: the0admin
      MINIO_SECRET_KEY: the0password
      FRONTEND_URL: http://localhost:3001
      JWT_SECRET: your-super-secret-jwt-key-change-this-in-production
      JWT_EXPIRES_IN: 24h
      STORAGE_PATH: /app/uploads/custom-bots
      CUSTOM_BOTS_BUCKET: custom-bots
      LOG_BUCKET: bot-logs
      BACKTEST_BUCKET: backtests
      BOT_API_URL: http://the0-api:3000
      PORT: 3000
      API_BASE_URL: http://localhost:3000
      MIGRATIONS_PATH: /app/src/database/migrations
    ports:
      - "3000:3000"
    command: sh -c "rm -rf dist && yarn install && yarn start:dev"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - the0-network

  # Development override for 0vers33r service with local development
  the0-analyzer:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ../services/0vers33r:/app
      - analyzer_venv:/app/.venv
    environment:
      # NATS configuration
      NATS_URL: nats://nats:4222
      
      # MinIO configuration  
      MINIO_ENDPOINT: minio:9000
      MINIO_USE_SSL: "false"
      MINIO_ACCESS_KEY: the0admin
      MINIO_SECRET_KEY: the0password
      CUSTOM_BOTS_BUCKET: custom-bots
      
      # PostgreSQL configuration
      DATABASE_URL: postgresql://the0:the0_password@postgres:5432/the0_oss
      
      # AI Analysis configuration (optional)
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      AI_SYSTEM_PROMPT: ${AI_SYSTEM_PROMPT:-}
      
      # Development configuration
      PYTHONPATH: /app
      PYTHONUNBUFFERED: "1"
      LOG_LEVEL: DEBUG
      
    command: >
      sh -c "
        apt-get update && 
        apt-get install -y gcc g++ libyara-dev pkg-config git curl &&
        pip install -r requirements.txt &&
        python main.py
      "
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - the0-network

volumes:
  frontend_node_modules:
  api_node_modules:
  analyzer_venv: