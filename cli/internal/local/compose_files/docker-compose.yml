services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    pull_policy: always
    environment:
      POSTGRES_DB: the0_oss
      POSTGRES_USER: the0
      POSTGRES_PASSWORD: the0_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - {{REPO_PATH}}/database/init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U the0 -d the0_oss"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - the0-network

  # MongoDB Database (for bot-runner)
  mongo:
    image: mongo:7-jammy
    pull_policy: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: the0_mongo_password
      MONGO_INITDB_DATABASE: bot_runner
    volumes:
      - mongo_data:/data/db
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD-SHELL", "mongosh --eval 'db.runCommand(\"ping\")' --quiet"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - the0-network

  # NATS Message Broker with JetStream
  nats:
    image: nats:2.10-alpine
    pull_policy: always
    command: ["-js", "-m", "8222", "--store_dir", "/data"]
    volumes:
      - nats_data:/data
    ports:
      - "4222:4222"  # NATS port
      - "8222:8222"  # HTTP monitoring port
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8222/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - the0-network

  # MinIO for S3-compatible storage
  minio:
    image: minio/minio:latest
    pull_policy: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: the0admin
      MINIO_ROOT_PASSWORD: the0password
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"  # API port
      - "9001:9001"  # Console port
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - the0-network

  # The0 API Service (TypeScript/NestJS)
  the0-api:
    build:
      context: {{REPO_PATH}}/api
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    pull_policy: always
    environment:
      # Database configuration
      DATABASE_URL: postgresql://the0:the0_password@postgres:5432/the0_oss?sslmode=disable
      DATABASE_TYPE: postgres

      # NATS configuration
      NATS_URLS: nats://nats:4222


      # MinIO configuration
      MINIO_ENDPOINT: minio # Internal endpoint hostname for API to connect to MinIO
      MINIO_PORT: "9000"
      MINIO_USE_SSL: "false"
      MINIO_ACCESS_KEY: the0admin
      MINIO_SECRET_KEY: the0password

      # Application configuration
      NODE_ENV: production
      PORT: 3000
      API_BASE_URL: http://localhost:3000

      # Frontend configuration
      FRONTEND_URL: http://localhost:3001

      # JWT configuration
      JWT_SECRET: your-super-secret-jwt-key-change-this-in-production
      JWT_EXPIRES_IN: 24h

      # Storage configuration
      STORAGE_PATH: /app/uploads/custom-bots
      CUSTOM_BOTS_BUCKET: custom-bots
      LOG_BUCKET: bot-logs
      BACKTEST_BUCKET: backtests

      # Bot API configuration (used by frontend API routes)
      BOT_API_URL: http://the0-api:3000

      # Runtime query server URL (standalone query-server service)
      RUNTIME_QUERY_URL: http://query-server:9477

    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://0.0.0.0:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - the0-network
    volumes:
      - the0-api-uploads:/app/uploads

  # Bot Runner Service (Go - single-process bot execution)
  bot-runner:
    build:
      context: {{REPO_PATH}}/runtime
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: the0/runtime:latest
    pull_policy: always
    environment:
      # Runtime image override (use locally built image for bot containers)
      RUNTIME_IMAGE: the0/runtime:latest

      # MongoDB configuration
      MONGO_URI: mongodb://root:the0_mongo_password@mongo:27017

      # NATS configuration (optional - enables instant updates)
      NATS_URL: nats://nats:4222

      # MinIO configuration
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: the0admin
      MINIO_SECRET_KEY: the0password
      MINIO_USE_SSL: "false"
      MINIO_LOGS_BUCKET: bot-logs
      MINIO_CODE_BUCKET: custom-bots
      MINIO_REGION: us-east-1

      # Docker configuration
      DOCKER_TEMP_DIR: /tmp/bot-runner
      TEMP_DIR: /tmp/bot-runner
      DOCKER_LOG_DIR: /var/log/bot-runner
      BOT_MEMORY_LIMIT_MB: "2048"
      BOT_CPU_SHARES: "1024"
      DOCKER_NETWORK: the0-oss-network

    ports:
      - "8080:8080"  # HTTP health endpoint
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - bot_runner_data:/app/data
      - /tmp/bot-runner:/tmp/bot-runner
    privileged: true
    sysctls:
      - net.ipv4.ip_forward=1
    depends_on:
      mongo:
        condition: service_healthy
      nats:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - the0-network
    command: ["/app/runtime", "bot-runner"]

  # Bot Scheduler Service (Go - single-process scheduled bot execution)
  bot-scheduler:
    build:
      context: {{REPO_PATH}}/runtime
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: the0/runtime:latest
    pull_policy: always
    environment:
      # Runtime image override (use locally built image for bot containers)
      RUNTIME_IMAGE: the0/runtime:latest

      # MongoDB configuration
      MONGO_URI: mongodb://root:the0_mongo_password@mongo:27017

      # NATS configuration (required for scheduler)
      NATS_URL: nats://nats:4222

      # MinIO configuration
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: the0admin
      MINIO_SECRET_KEY: the0password
      MINIO_USE_SSL: "false"
      MINIO_LOGS_BUCKET: bot-logs
      MINIO_CODE_BUCKET: custom-bots

      # Docker configuration
      DOCKER_TEMP_DIR: /tmp/bot-scheduler
      TEMP_DIR: /tmp/bot-scheduler
      DOCKER_LOG_DIR: /var/log/bot-scheduler
      BOT_MEMORY_LIMIT_MB: "2048"
      BOT_CPU_SHARES: "1024"
      DOCKER_NETWORK: the0-oss-network

    ports:
      - "8082:8080"  # HTTP health endpoint
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - bot_scheduler_data:/app/data
      - /tmp/bot-scheduler:/tmp/bot-scheduler
    privileged: true
    sysctls:
      - net.ipv4.ip_forward=1
    depends_on:
      mongo:
        condition: service_healthy
      nats:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - the0-network
    command: ["/app/runtime", "bot-scheduler"]

  # Query Server Service (Go - standalone query execution)
  query-server:
    build:
      context: {{REPO_PATH}}/runtime
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: the0/runtime:latest
    pull_policy: always
    environment:
      # Runtime image override (use locally built image for bot containers)
      RUNTIME_IMAGE: the0/runtime:latest

      # MongoDB configuration
      MONGO_URI: mongodb://root:the0_mongo_password@mongo:27017

      # MinIO configuration
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: the0admin
      MINIO_SECRET_KEY: the0password
      MINIO_USE_SSL: "false"
      MINIO_CODE_BUCKET: custom-bots

      # Docker configuration
      DOCKER_TEMP_DIR: /tmp/query-server
      TEMP_DIR: /tmp/query-server
      DOCKER_NETWORK: the0-oss-network

      # Query server port
      QUERY_SERVER_PORT: "9477"

    ports:
      - "9477:9477"  # Query server endpoint
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/query-server:/tmp/query-server
    privileged: true
    sysctls:
      - net.ipv4.ip_forward=1
    depends_on:
      mongo:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9477/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - the0-network
    command: ["/app/runtime", "query-server"]

  the0-frontend:
    build:
      context: {{REPO_PATH}}/frontend
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
        - NEXT_PUBLIC_API_URL=http://localhost:3000
        - NEXT_PUBLIC_DOCS_URL=http://localhost:3002
    pull_policy: always
    environment:
      # API configuration (runtime)
      BOT_API_URL: http://the0-api:3000

      # CLI download configuration
      CLI_DOWNLOAD_BASE_URL: https://github.com/alexanderwanyoike/the0/releases/download
      CLI_INSTALL_BASE_URL: http://localhost:3001
      NEXT_PUBLIC_CLI_INSTALL_BASE_URL: http://localhost:3001

      # JWT configuration (for admin auth middleware)
      JWT_SECRET: your-super-secret-jwt-key-change-this-in-production

      # App configuration
      NEXT_PUBLIC_APP_NAME: "the0"
      NEXT_PUBLIC_APP_VERSION: "1.0.0"
      NEXT_BASE_URL: http://localhost:3001

      NODE_ENV: production

    ports:
      - "3001:3000"
    depends_on:
      the0-api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://0.0.0.0:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - the0-network
    volumes:
      - the0-frontend-node-modules:/app/node_modules

  # the0 Documentation Site (VitePress)
  the0-docs:
    build:
      context: {{REPO_PATH}}/docs
      dockerfile: Dockerfile
    pull_policy: always
    ports:
      - "3002:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - the0-network

  # Development tools (optional)
  adminer:
    image: adminer:4.8.1
    pull_policy: always
    ports:
      - "8081:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    depends_on:
      - postgres
    profiles:
      - dev
    networks:
      - the0-network

  # NATS monitoring (optional)
  nats-monitoring:
    image: natsio/nats-box:latest
    pull_policy: always
    command: ["nats", "server", "check", "connection", "--server=nats://nats:4222"]
    depends_on:
      - nats
    profiles:
      - dev
    networks:
      - the0-network

volumes:
  postgres_data:
    driver: local
  mongo_data:
    driver: local
  nats_data:
    driver: local
  minio_data:
    driver: local
  bot_runner_data:
    driver: local
  bot_scheduler_data:
    driver: local
  the0-api-uploads:
    driver: local
  the0-frontend-node-modules:
    driver: local

networks:
  the0-network:
    driver: bridge
    name: the0-oss-network
