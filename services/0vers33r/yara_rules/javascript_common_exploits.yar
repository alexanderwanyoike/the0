/*
   JavaScript Common Exploit Patterns
   Common attack vectors and exploitation techniques
   Severity: HIGH/MEDIUM - Frequently seen in malicious code
*/

rule JS_XSS_Payload_Patterns {
    meta:
        description = "Detects XSS payload patterns"
        severity = "high"
        author = "0VERS33R"

    strings:
        $xss1 = "<script>" nocase
        $xss2 = "javascript:" nocase
        $xss3 = "onerror=" nocase
        $xss4 = "onload=" nocase
        $xss5 = "onclick=" nocase
        $xss6 = "onmouseover=" nocase
        $xss7 = "onfocus=" nocase
        $xss8 = "alert(" nocase
        $xss9 = "confirm(" nocase
        $xss10 = "prompt(" nocase

    condition:
        2 of them
}

rule JS_SQL_Injection_Patterns {
    meta:
        description = "Detects SQL injection patterns in JavaScript"
        severity = "high"
        author = "0VERS33R"

    strings:
        $sql1 = "SELECT * FROM" nocase
        $sql2 = "UNION SELECT" nocase
        $sql3 = "DROP TABLE" nocase
        $sql4 = "INSERT INTO" nocase
        $sql5 = "UPDATE SET" nocase
        $sql6 = "DELETE FROM" nocase
        $sql7 = "' OR '1'='1" nocase
        $sql8 = "\" OR \"1\"=\"1" nocase
        $sql9 = "'; DROP TABLE" nocase

    condition:
        any of them
}

rule JS_CSRF_Token_Bypass {
    meta:
        description = "Detects CSRF token bypass attempts"
        severity = "medium"
        author = "0VERS33R"

    strings:
        $csrf1 = "csrf" nocase
        $csrf2 = "_token" nocase
        $csrf3 = "authenticity_token" nocase
        $method1 = "POST" nocase
        $method2 = "PUT" nocase
        $method3 = "DELETE" nocase
        $bypass1 = "replace(" nocase
        $bypass2 = "remove(" nocase

    condition:
        1 of ($csrf1, $csrf2, $csrf3) and 1 of ($method1, $method2, $method3) and 1 of ($bypass1, $bypass2)
}

rule JS_Path_Traversal {
    meta:
        description = "Detects path traversal attack patterns"
        severity = "high"
        author = "0VERS33R"

    strings:
        $path1 = "../" nocase
        $path2 = "..\\\\" nocase
        $path3 = "%2e%2e%2f" nocase
        $path4 = "%2e%2e%5c" nocase
        $path5 = "..../" nocase
        $path6 = "....//" nocase
        $file1 = "/etc/passwd" nocase
        $file2 = "/etc/shadow" nocase
        $file3 = "C:\\Windows\\System32" nocase

    condition:
        2 of ($path1, $path2, $path3, $path4, $path5, $path6) or 
        any of ($file1, $file2, $file3)
}

rule JS_Command_Injection {
    meta:
        description = "Detects command injection patterns"
        severity = "critical"
        author = "0VERS33R"

    strings:
        $cmd1 = "exec(" nocase
        $cmd2 = "system(" nocase
        $cmd3 = "shell_exec(" nocase
        $cmd4 = "passthru(" nocase
        $inject1 = ";" nocase
        $inject2 = "&&" nocase
        $inject3 = "||" nocase
        $inject4 = "|" nocase
        $inject5 = "`" nocase

    condition:
        1 of ($cmd1, $cmd2, $cmd3, $cmd4) and 2 of ($inject1, $inject2, $inject3, $inject4, $inject5)
}

rule JS_Prototype_Pollution {
    meta:
        description = "Detects prototype pollution attempts"
        severity = "high"
        author = "0VERS33R"

    strings:
        $proto1 = "__proto__" nocase
        $proto2 = "prototype" nocase
        $proto3 = "constructor" nocase
        $assign1 = "Object.assign(" nocase
        $merge1 = "merge(" nocase
        $extend1 = "extend(" nocase
        $pollute1 = "isPrototypeOf" nocase

    condition:
        2 of ($proto1, $proto2, $proto3) and 1 of ($assign1, $merge1, $extend1, $pollute1)
}

rule JS_Cookie_Theft {
    meta:
        description = "Detects cookie theft patterns"
        severity = "high"
        author = "0VERS33R"

    strings:
        $cookie1 = "document.cookie" nocase
        $steal1 = "send(" nocase
        $steal2 = "post(" nocase
        $steal3 = "get(" nocase
        $steal4 = "fetch(" nocase
        $external1 = "http://" nocase
        $external2 = "https://" nocase
        $encode1 = "encodeURIComponent(" nocase

    condition:
        $cookie1 and 1 of ($steal1, $steal2, $steal3, $steal4) and 1 of ($external1, $external2) and $encode1
}

rule JS_LocalStorage_Manipulation {
    meta:
        description = "Detects suspicious localStorage manipulation"
        severity = "medium"
        author = "0VERS33R"

    strings:
        $storage1 = "localStorage.setItem(" nocase
        $storage2 = "localStorage.getItem(" nocase
        $storage3 = "sessionStorage.setItem(" nocase
        $storage4 = "sessionStorage.getItem(" nocase
        $sensitive1 = "token" nocase
        $sensitive2 = "password" nocase
        $sensitive3 = "credential" nocase
        $sensitive4 = "key" nocase

    condition:
        1 of ($storage1, $storage2, $storage3, $storage4) and 1 of ($sensitive1, $sensitive2, $sensitive3, $sensitive4)
}

rule JS_WebSocket_Exploit {
    meta:
        description = "Detects suspicious WebSocket usage"
        severity = "medium"
        author = "0VERS33R"

    strings:
        $ws1 = "new WebSocket(" nocase
        $ws2 = "WebSocket(" nocase
        $ws3 = "ws://" nocase
        $ws4 = "wss://" nocase
        $suspicious1 = "127.0.0.1" nocase
        $suspicious2 = "localhost" nocase
        $suspicious3 = ".onion" nocase

    condition:
        1 of ($ws1, $ws2) and 1 of ($ws3, $ws4) and 1 of ($suspicious1, $suspicious2, $suspicious3)
}