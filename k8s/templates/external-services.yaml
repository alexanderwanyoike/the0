# External LoadBalancer services for accessing the0 from outside the cluster
# These services provide feature parity between minikube and production
# In minikube: accessible via `minikube tunnel` on localhost  
# In production: accessible via cloud LoadBalancer IPs

{{- if .Values.externalServices.enabled }}
---
# Frontend LoadBalancer Service (localhost:3001)
apiVersion: v1
kind: Service
metadata:
  name: {{ include "the0.fullname" . }}-frontend-external
  labels:
    {{- include "the0.labels" . | nindent 4 }}
    app.kubernetes.io/component: frontend-external
spec:
  type: NodePort
  ports:
    - port: 3001
      targetPort: 3000
      nodePort: {{ .Values.externalServices.nodePort.frontend }}
      protocol: TCP
      name: http
  selector:
    {{- include "the0.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: frontend

---
# API LoadBalancer Service (localhost:3000)
apiVersion: v1
kind: Service
metadata:
  name: {{ include "the0.fullname" . }}-api-external
  labels:
    {{- include "the0.labels" . | nindent 4 }}
    app.kubernetes.io/component: api-external
spec:
  type: NodePort
  ports:
    - port: 3000
      targetPort: 3000
      nodePort: {{ .Values.externalServices.nodePort.api }}
      protocol: TCP
      name: http
  selector:
    {{- include "the0.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: api

---
# MinIO LoadBalancer Service (localhost:9000, localhost:9001)
apiVersion: v1
kind: Service
metadata:
  name: {{ include "the0.fullname" . }}-minio-external
  labels:
    {{- include "the0.labels" . | nindent 4 }}
    app.kubernetes.io/component: minio-external
spec:
  type: NodePort
  ports:
    - port: 9000
      targetPort: 9000
      nodePort: {{ .Values.externalServices.nodePort.minio }}
      protocol: TCP
      name: api
    - port: 9001
      targetPort: 9001
      nodePort: {{ add .Values.externalServices.nodePort.minio 1 }}
      protocol: TCP
      name: console
  selector:
    {{- include "the0.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: minio

---
# Docs LoadBalancer Service (localhost:3002)
apiVersion: v1
kind: Service
metadata:
  name: {{ include "the0.fullname" . }}-docs-external
  labels:
    {{- include "the0.labels" . | nindent 4 }}
    app.kubernetes.io/component: docs-external
spec:
  type: NodePort
  ports:
    - port: 3002
      targetPort: 3000
      nodePort: {{ .Values.externalServices.nodePort.docs }}
      protocol: TCP
      name: http
  selector:
    {{- include "the0.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: docs

---
# Bot Runner Master NodePort Service
apiVersion: v1
kind: Service
metadata:
  name: {{ include "the0.fullname" . }}-bot-runner-master-external
  labels:
    {{- include "the0.labels" . | nindent 4 }}
    app.kubernetes.io/component: bot-runner-master-external
spec:
  type: NodePort
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
      nodePort: 30080
    - port: 50051
      targetPort: 50051
      protocol: TCP
      name: grpc
      nodePort: 30051
  selector:
    {{- include "the0.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: bot-runner-master

---
# Backtest Runner Master NodePort Service
apiVersion: v1
kind: Service
metadata:
  name: {{ include "the0.fullname" . }}-backtest-runner-master-external
  labels:
    {{- include "the0.labels" . | nindent 4 }}
    app.kubernetes.io/component: backtest-runner-master-external
spec:
  type: NodePort
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
      nodePort: 30081
    - port: 50052
      targetPort: 50052
      protocol: TCP
      name: grpc
      nodePort: 30052
  selector:
    {{- include "the0.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: backtest-runner-master

---
# Bot Scheduler Master NodePort Service
apiVersion: v1
kind: Service
metadata:
  name: {{ include "the0.fullname" . }}-bot-scheduler-master-external
  labels:
    {{- include "the0.labels" . | nindent 4 }}
    app.kubernetes.io/component: bot-scheduler-master-external
spec:
  type: NodePort
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
      nodePort: 30082
    - port: 50053
      targetPort: 50053
      protocol: TCP
      name: grpc  
      nodePort: 30053
  selector:
    {{- include "the0.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: bot-scheduler-master

---
# AI Agent NodePort Service (localhost:8003)
apiVersion: v1
kind: Service
metadata:
  name: {{ include "the0.fullname" . }}-ai-agent-external
  labels:
    {{- include "the0.labels" . | nindent 4 }}
    app.kubernetes.io/component: ai-agent-external
spec:
  type: NodePort
  ports:
    - port: 8000
      targetPort: 8000
      nodePort: {{ .Values.externalServices.nodePort.aiAgent }}
      protocol: TCP
      name: http
  selector:
    {{- include "the0.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: ai-agent
{{- end }}